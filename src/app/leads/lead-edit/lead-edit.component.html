<app-breadcrumb></app-breadcrumb>
<div class="container">
  <div class="row page-title">
    <div class="col">
      <h4 class="m-0">Lead <span class="badge badge-pill badge-primary" *ngIf="lead?.closedById">Closed</span></h4>
    </div>
  </div>
  <form [formGroup]="leadEditForm" (ngSubmit)="SaveLead(true, leadNote)" autocompleteOff>
    <div class="row align-items-start">
      <div class="col-xl-8">
        <h5>Person</h5>
        <app-person-details *ngIf="person" [personDetails]="person"></app-person-details>
        <div #spacer></div>
        <div class="sub-info" stickyThing [spacer]="spacer" marginTop="66">
          <h5>More Info</h5>
          <accordion [closeOthers]="true">
            <accordion-group *ngFor="let item of subNav">
              <button class="btn btn-link btn-block clearfix" accordion-heading type="button"
                (click)="getMoreInfo(item)">
                <div class="pull-left float-left">
                  {{item?.label}}
                  <ng-container *ngIf="summaryTotals; else loadingInfo">
                    <ng-container *ngIf="isObject(summaryTotals[item?.value]); else simpleValue">
                      <span class="badge badge-pill badge-success mr-1"> {{summaryTotals[item?.value]?.active}} </span>
                      <span class="badge badge-pill badge-primary"> {{summaryTotals[item?.value]?.inactive}}</span>
                    </ng-container>
                    <ng-template #simpleValue>
                      <span class="badge badge-pill badge-primary"> {{summaryTotals[item?.value] || '0'}}</span>
                    </ng-template>
                  </ng-container>
                  <ng-template #loadingInfo>
                    <span class="badge badge-pill badge-primary"><i
                        class="fas fa-spinner fa-pulse d-inline-block"></i></span>
                  </ng-template>
                </div>
                <span class="float-right pull-right" (click)="$event.stopPropagation()">
                  <ng-container [ngSwitch]="item?.value">
                    <a [routerLink]="['/property-centre/detail', 0, 'edit']"
                      [queryParams]="{isNewProperty: true, leadId:lead?.leadId,  lastKnownPerson: personParams}"
                      *ngSwitchCase="'properties'">Create</a>
                  </ng-container>
                </span>
              </button>
              <ng-container [ngSwitch]="item?.value">
                <app-shared-property-list *ngSwitchCase="'properties'" [moreInfo]="moreInfo"
                  [isLeadClosed]="isLeadClosed" [isLead]="true" [personId]="person?.personId"
                  (associatedProperty)="getAssociatedProperty($event)">
                </app-shared-property-list>
                <app-contactgroups-detail-instructions *ngSwitchCase="'instructions'" [moreInfo]="moreInfo"
                  [personId]="person?.personId" [closedCounter]="summaryTotals?.instructions?.inactive">
                </app-contactgroups-detail-instructions>
                <app-contactgroups-detail-offers *ngSwitchCase="'offers'" [moreInfo]="moreInfo"
                  [personId]="person?.personId" [closedCounter]="summaryTotals?.offers?.inactive">
                </app-contactgroups-detail-offers>
                <app-contactgroups-detail-searches *ngSwitchCase="'searches'" [moreInfo]="moreInfo"
                  [personId]="person?.personId" [closedCounter]="summaryTotals?.searches?.inactive">
                </app-contactgroups-detail-searches>
                <app-shared-valuation-list *ngSwitchCase="'valuations'" [moreInfo]="moreInfo"
                [personId]="person?.personId" [closedCounter]="summaryTotals?.valuations?.inactive"></app-shared-valuation-list>
                <app-contactgroups-detail-lettings-managements *ngSwitchCase="'lettingsManagements'"
                  [moreInfo]="moreInfo" [personId]="person?.personId"
                  [closedCounter]="summaryTotals?.lettingsManagements?.inactive">
                </app-contactgroups-detail-lettings-managements>
                <app-contactgroups-detail-home-helper *ngSwitchCase="'homeHelpers'" [moreInfo]="moreInfo"
                  [personId]="person?.personId" [closedCounter]="summaryTotals?.homeHelpers?.inactive">
                </app-contactgroups-detail-home-helper>
                <app-shared-lead-register *ngSwitchCase="'leads'" [moreInfo]="moreInfo" [personId]="person?.personId"
                  [closedCounter]="summaryTotals?.leads?.inactive">
                </app-shared-lead-register>
              </ng-container>
            </accordion-group>
          </accordion>
        </div>
        <div class="mb-3"></div>
        <h5>Lead Info</h5>
        <div class="list-group mb-3">
          <div class="list-group-item pt-4 pb-3">
            <div class="row">
              <div class="col-lg">
                <div class="form-group">
                  <label for="leadType">Type</label>
                  <select class="custom-select custom-select-sm" id="leadType" formControlName="leadTypeId"
                    [attr.disabled]="isLeadClosed ? true : null" 
                    [ngClass]="{'is-invalid': formErrors?.leadTypeId, 
                    'custom-select custom-select-sm': !isLeadClosed, 
                    'form-control form-control-sm form-control-plaintext': isLeadClosed}">
                    <option value=""></option>
                    <option selected *ngFor="let leadType of leadTypes" [value]=leadType.id>{{leadType?.value}}</option>
                  </select>
                  <div class="invalid-feedback">{{formErrors?.leadTypeId}}</div>
                </div>
              </div>
              <div class="col-lg">
                <div class="form-group">
                  <label for="chaseDate">Chase date</label>
                  <input type="text" id="chaseDate" placeholder="dd/mm/yyyy" class="form-control form-control-sm"
                    formControlName="nextChaseDate"
                    [bsConfig]="{showWeekNumbers:false, useUtc: false, dateInputFormat: 'DD/MM/YYYY', minDate:todaysDate, customTodayClass: 'font-weight-bold'}"
                    bsDatepicker [attr.disabled]="isLeadClosed ? true : null"
                    (bsValueChange)="onChaseDateChange($event)" [ngClass]="{'is-invalid': (formErrors?.nextChaseDate), 'form-control-plaintext': isLeadClosed}">
                  <div class="invalid-feedback">{{formErrors?.nextChaseDate}}</div>
                </div>
              </div>
              <div class="col-lg">
                <div class="form-group">
                  <label for="chaser">Chaser</label>
                  <app-staffmember-finder [staffMemberId]="lead?.ownerId" (ownerChanged)="onOwnerChanged($event)"
                    [isDisabled]="isLeadClosed ? true : false">
                  </app-staffmember-finder>
                </div>
              </div>
              <div class="col-12" *ngIf="!isLeadClosed">
                <div class="form-group">
                  <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input" id="closeLead" formControlName="closeLead"
                      (change)="closeLeadChanged(lead)">
                    <label class="custom-control-label" for="closeLead">Mark as <span
                        class="badge badge-pill badge-primary">Closed</span></label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <h5>Associated Property</h5>
        <ng-container *ngIf="lead?.relatedProperty; else noProperty">
          <p class="d-flex d-sm-block">
            <ng-container *ngIf="!isMessageVisible && !isLeadClosed">
              <button class="btn btn-light btn-sm mr-2" type="button" aria-label="remove" (click)="removeProperty()">
                <span aria-hidden="true">Ã—</span>
              </button>
            </ng-container>
            <a class="text-left mobile-btn"
              [routerLink]="['/property-centre/detail/', lead?.relatedProperty?.propertyId]">
              {{lead?.relatedProperty?.address | formatAddress}}
            </a>
            <ng-container *ngIf="!isMessageVisible && !isLeadClosed">
              <button class="btn btn-light btn-sm ml-2" type="button" (click)="navigateToNewValuation(lead?.relatedProperty?.propertyId)">Create Val.
              </button>
            </ng-container>
          </p>
        </ng-container>
        <ng-template #noProperty>
          <p>
            No property associated to this lead
          </p>
        </ng-template>
        <h5>Notes</h5>
        <div class="list-group" *ngIf="!isLeadClosed">
          <div class="list-group-item add-note py-4">
            <app-lead-note #leadNote [selectedPerson]="person"
              (leadNote)="getNewPersonNote($event)" [noteRequiredWarning]="noteRequiredWarning"
              [isUpdateComplete]="isUpdateComplete"></app-lead-note>
          </div>
        </div>
        <app-notes [personNotes]="personNotes" [person]="person"  [pageNumber]="page"
          [bottomReached]="bottomReached" [showNoteInput]="false"></app-notes>
      </div>
    </div>
    <div class="form-actions">
      <div class="container px-lg-4">
        <div class="row justify-content-end w-100 no-gutters">
          <div class="col-sm-10 d-flex">
            <button (click)="cancel()" type="button" class="btn btn-light mr-2" *ngIf="!isLeadClosed">Cancel</button>
            <button (click)="cancel()" type="button" class="btn btn-secondary mr-2" *ngIf="isLeadClosed">Back</button>
            <button type="submit" class="btn btn-secondary mr-2" *ngIf="!isLeadClosed">Save</button>
            <button *ngIf="showSaveAndNext && !leadsListCompleted" (click)="traverseLeads()" type="button"
              class="btn btn-secondary" [isOpen]="leadsListCompleted"
              [tooltip]="leadsListCompleted ? 'You have reached the end of the list' : null || !leadEditForm.valid? errorMessage?.displayMessage : ''"
              placement="top" [attr.disabled]="isLeadClosed ? true : null ">Save &
              Next</button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>
<app-additional-info [id]="lead?.leadId ? 'L-'+lead?.leadId : ''"></app-additional-info>
