<div class="row">
  <div class="row__item row__item--aside">
    <app-person-details *ngIf="person" [personDetails]="person" [isClickable]="false" [showViewPerson]="true"></app-person-details>
    <app-sidenav-item [sideNavItems]="sideNavItems" [summaryTotals]="summaryTotals" [scrollToItem]="mainRowItem" (selectedItem)="getSelectedItem($event)"></app-sidenav-item>
  </div>

  <div #mainRowItem class="row__item">
    <ng-container *ngTemplateOutlet="editForm"></ng-container>
    <ng-container [ngSwitch]="moreInfo">
      <app-shared-property-list *ngSwitchCase="'properties'" [moreInfo]="moreInfo" [isLeadClosed]="isLeadClosed" [isLead]="true" [personId]="person?.personId" (associatedProperty)="getAssociatedProperty($event)"></app-shared-property-list>
      <app-contactgroups-detail-instructions *ngSwitchCase="'instructions'" [moreInfo]="moreInfo" [personId]="person?.personId" [closedCounter]="summaryTotals?.instructions?.inactive"></app-contactgroups-detail-instructions>
      <app-contactgroups-detail-offers *ngSwitchCase="'offers'" [moreInfo]="moreInfo" [personId]="person?.personId" [closedCounter]="summaryTotals?.offers?.inactive"></app-contactgroups-detail-offers>
      <app-contactgroups-detail-searches *ngSwitchCase="'searches'" [moreInfo]="moreInfo" [personId]="person?.personId" [closedCounter]="summaryTotals?.searches?.inactive"></app-contactgroups-detail-searches>
      <app-shared-valuation-list *ngSwitchCase="'valuations'" [moreInfo]="moreInfo" [personId]="person?.personId" [closedCounter]="summaryTotals?.valuations?.inactive"></app-shared-valuation-list>
      <app-contactgroups-detail-lettings-managements *ngSwitchCase="'lettingsManagements'" [moreInfo]="moreInfo" [personId]="person?.personId" [closedCounter]="summaryTotals?.lettingsManagements?.inactive"></app-contactgroups-detail-lettings-managements>
      <app-contactgroups-detail-home-helper *ngSwitchCase="'homeHelpers'" [moreInfo]="moreInfo" [personId]="person?.personId" [closedCounter]="summaryTotals?.homeHelpers?.inactive"></app-contactgroups-detail-home-helper>
      <app-shared-lead-register *ngSwitchCase="'leads'" [moreInfo]="moreInfo" [personId]="person?.personId" [closedCounter]="summaryTotals?.leads?.inactive"></app-shared-lead-register>
      <app-notes *ngSwitchCase="'notes'" [personNotes]="personNotes" [person]="person" [pageNumber]="page" [bottomReached]="bottomReached" [showNoteInput]="false" [showCreateNoteButton]="false"></app-notes>
      <!-- <ng-container *ngSwitchDefault>
        <div class="title">
          <h2>Lead<span class="pill pill--onRight" *ngIf="lead?.closedById">Closed</span></h2>
        </div>
        <form [formGroup]="leadEditForm" (ngSubmit)="SaveLead(true, leadNote)" autocompleteOff>
          <fieldset>
            <label for="leadType">Type</label>
            <span class="select">
              <select id="leadType" formControlName="leadTypeId" [attr.disabled]="isLeadClosed ? true : null"
                [ngClass]="{'is-invalid': formErrors?.leadTypeId}">
                <option value=""></option>
                <option selected *ngFor="let leadType of leadTypes" [value]=leadType.id>{{leadType?.value}}</option>
              </select>
            </span>
            {{formErrors?.leadTypeId}}
          </fieldset>

          <fieldset>
            <label for="chaseDate">Chase date</label>
            <input type="text" id="chaseDate" placeholder="dd/mm/yyyy" formControlName="nextChaseDate"
              [bsConfig]="{showWeekNumbers:false, useUtc: false, dateInputFormat: 'DD/MM/YYYY', minDate:tomorrowsDate, customTodayClass: 'font-weight-bold'}"
              bsDatepicker [attr.disabled]="isLeadClosed ? true : null" #datepicker="bsDatepicker"
              [appNoDoubleTap]='datepicker' (bsValueChange)="onChaseDateChange($event)"
              [ngClass]="{'is-invalid': (formErrors?.nextChaseDate)}">
            {{formErrors?.nextChaseDate}}
          </fieldset>

          <fieldset>
            <label for="chaser">Chaser</label>
            <app-staff-member-finder [staffMemberId]="lead?.ownerId || leadEditForm.get('ownerId').value"
              [listType]="'activeStaffMembers'" (selectedStaffMemberId)="getSelectedStaffMemberId($event)"
              [isRequired]="!leadEditForm.get('ownerId').value" [isDisabled]="isLeadClosed ? true : false">
            </app-staff-member-finder>
          </fieldset>

          <fieldset *ngIf="!isLeadClosed">
            <span class="checkbox">
              <span>
                <input type="checkbox" id="closeLead" formControlName="closeLead" (change)="closeLeadChanged(lead)">
                <label for="closeLead">Mark as <span class="badge badge-pill badge-primary">Closed</span></label>
              </span>
            </span>
          </fieldset>

          <h3>Associated Property</h3>
          <div class="table" *ngIf="lead?.relatedProperty; else noProperty">
            <table class="table--mobile table--rowHover">
              <thead>
                <tr>
                  <th colspan="2">Address</th>
                </tr>
              </thead>
              <tbody>
                <tr [routerLink]="['/property-centre/detail/', lead?.relatedProperty?.propertyId]">
                  <td data-title="Address">
                    <span class="cell-content">
                      {{lead?.relatedProperty?.address | formatAddress}}
                    </span>
                  </td>
                  <td data-title="Actions">
                    <span class="cell-content">
                      <div dropdown placement="bottom right" class="dropdown">
                        <a class="btn dropdown-toggle" href [id]="'button'" dropdownToggle
                          (click)="$event.stopPropagation(); false" [attr.aria-controls]="'dropdown'"><svg aria-hidden="true"
                            width="64" height="64" viewBox="0 0 64 64" class="icon">
                            <ellipse class="st0" cx="32" cy="10.5" rx="5.9" ry="6" />
                            <ellipse class="st0" cx="32" cy="32" rx="5.9" ry="6" />
                            <ellipse class="st0" cx="32" cy="53.5" rx="5.9" ry="6" />
                          </svg></a>
                        <ul [id]="'dropdown'" *dropdownMenu class="dropdown-menu dropdown-menu-right" role="menu"
                          [attr.aria-labelledby]="'button'">
                          <li role="menuitem">
                            <a class="dropdown-item">View Property</a>
                          </li>
                          <li *ngIf="!isMessageVisible && !isLeadClosed">
                            <button class="btn btn-light btn-sm ml-2" type="button" aria-label="remove"
                              (click)="removeProperty()">Remove Property</button>
                          </li>
                          <li *ngIf="!isMessageVisible">
                            <button class="btn btn-light btn-sm ml-2" type="button" data-cy="createVal"
                              (click)="navigateToNewValuation(lead?.relatedProperty?.propertyId)">Create Val.</button>
                          </li>
                        </ul>
                      </div>
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <ng-template #noProperty>
            <p>No property associated to this lead</p>
          </ng-template>

        </form>
      </ng-container> -->
    </ng-container>
  </div>
</div>


<ng-template #editForm>
  <div class="title">
    <h2>Lead<span class="pill pill--onRight" *ngIf="lead?.closedById">Closed</span></h2>
    <!-- <a class="btn btn--positive"><svg aria-hidden="true" width="64" height="64" viewBox="0 0 64 64" class="icon icon--s icon--onLeft"><path d="M60 35.9H4c-2.2 0-4-1.8-4-4v0c0-2.2 1.8-4 4-4h56c2.2 0 4 1.8 4 4v0C64 34.1 62.2 35.9 60 35.9z"></path><path d="M28 59.9v-56c0-2.2 1.8-4 4-4h0c2.2 0 4 1.8 4 4v56c0 2.2-1.8 4-4 4h0C29.8 63.9 28 62.2 28 59.9z" class="plus-vertical"></path></svg>Contact Group</a> -->
  </div>
  <form [formGroup]="leadEditForm" (ngSubmit)="SaveLead(true, leadNote)" autocompleteOff>
    <div class="card card--horizontal">
      <div class="card__body">
        <ol class="list list--split list--split-60-40">
          <li>
            <h3 class="txt--title">Lead details</h3>
            <div class="inline-parent inline-parent__hasLabels">
              <fieldset class="inline-child">
                <label for="leadType">Type</label>
                <span class="select">
                  <select id="leadType" formControlName="leadTypeId" [attr.disabled]="isLeadClosed ? true : null"
                    [ngClass]="{'is-invalid': formErrors?.leadTypeId}">
                    <option value=""></option>
                    <option selected *ngFor="let leadType of leadTypes" [value]=leadType.id>{{leadType?.value}}</option>
                  </select>
                </span>
                {{formErrors?.leadTypeId}}
              </fieldset>

              <fieldset class="inline-child" [ngClass]="{'invalid': (formErrors?.nextChaseDate)}">
                <label for="chaseDate">Chase date</label>
                <input type="text" id="chaseDate" placeholder="dd/mm/yyyy" formControlName="nextChaseDate"
                  [bsConfig]="{showWeekNumbers:false, useUtc: false, dateInputFormat: 'DD/MM/YYYY', minDate:tomorrowsDate, customTodayClass: 'font-weight-bold'}"
                  bsDatepicker [attr.disabled]="isLeadClosed ? true : null" #datepicker="bsDatepicker"
                  [appNoDoubleTap]='datepicker' (bsValueChange)="onChaseDateChange($event)">
                  <p class="message message--negative">{{formErrors?.nextChaseDate}}</p>
              </fieldset>

              <fieldset class="inline-child">
                <label for="chaser">Chaser</label>
                <app-staff-member-finder [staffMemberId]="lead?.ownerId || leadEditForm.get('ownerId').value"
                  [listType]="'activeStaffMembers'" (selectedStaffMemberId)="getSelectedStaffMemberId($event)"
                  [isRequired]="!leadEditForm.get('ownerId').value" [isDisabled]="isLeadClosed ? true : false">
                </app-staff-member-finder>
              </fieldset>
            </div>

            <fieldset *ngIf="!isLeadClosed">
              <span class="checkbox">
                <span>
                  <input type="checkbox" id="closeLead" formControlName="closeLead" (change)="closeLeadChanged(lead)">
                  <label for="closeLead">Mark as <span class="badge badge-pill badge-primary">Closed</span></label>
                </span>
              </span>
            </fieldset>

            <h3 class="txt--title">Associated Property</h3>
            <ng-container *ngIf="lead?.relatedProperty; else noProperty">
              <!-- <div *ngIf="properties" class="search-results" infiniteScroll [infiniteScrollDistance]="5" [infiniteScrollUpDistance]="1.5" [infiniteScrollThrottle]="20" [immediateCheck]="true" [alwaysCallback]="true"></div> -->
              <ol class="list">
                <li [routerLink]="['/property-centre/detail/', lead?.relatedProperty?.propertyId]">
                  {{lead?.relatedProperty?.address | formatAddress}}
                  <div class="btn--container flexRight">
                    <button class="btn btn--ghost btn--hoverNegative" type="button" aria-label="remove" (click)="removeProperty()" *ngIf="!isMessageVisible && !isLeadClosed"><svg aria-hidden="true" width="64" height="64" viewBox="0 0 64 64" class="icon icon--s icon--onLeft"><path d="M11.4 56.1c0 3.8 3.1 6.9 6.9 6.9h27.4c3.8 0 6.9-3.1 6.9-6.9V14.8H11.4V56.1zM19.9 31.6l4.9-4.9L32 34l7.3-7.3 4.9 4.9 -7.3 7.3 7.3 7.3 -4.9 4.9L32 43.8l-7.3 7.3 -4.9-4.9 7.3-7.3L19.9 31.6zM44 4.4L40.6 1H23.4L20 4.4H8v6.9h48V4.4H44z"></path></svg>Remove</button>
                    <button class="btn btn--positive" type="button" data-cy="createVal" (click)="navigateToNewValuation(lead?.relatedProperty?.propertyId)" *ngIf="!isMessageVisible"><svg aria-hidden="true" width="64" height="64" viewBox="0 0 64 64" class="icon icon--s icon--onLeft"><path class="horizontal" d="M61 28H3c-1.7 0-3 1.8-3 3.5v1.1C0 34.2 1.3 36 3 36h58c1.7 0 3-1.8 3-3.5v-1C64 29.8 62.7 28 61 28z"></path><path class="vertical" d="M36 61V3c0-1.7-1.8-3-3.5-3l-1.1 0C29.8 0 28 1.3 28 3v58c0 1.7 1.8 3 3.5 3h1C34.2 64 36 62.7 36 61z"></path></svg>Valuation</button>
                  </div>
                </li>
              </ol>
            </ng-container>
            <ng-template #noProperty>
              <p>No property associated to this lead</p>
            </ng-template>
          </li>
          <li class="width30pc" *ngIf="lead?.relatedProperty; else noProperty">
            <div class="wrapper--note" *ngIf="!isLeadClosed">
              <app-lead-note #leadNote [selectedPerson]="person" (leadNote)="getNewPersonNote($event)" [noteRequiredWarning]="noteRequiredWarning" [isUpdateComplete]="isUpdateComplete"></app-lead-note>
            </div>
          </li>
        </ol>
      </div>
    </div>





    <footer class="footer">
      <button (click)="cancel()" type="button" class="btn btn--ghost" *ngIf="!isLeadClosed">Cancel</button>
      <button (click)="cancel()" type="button" class="btn btn--ghost" *ngIf="isLeadClosed">Back</button>
      <button type="submit" class="btn btn--positive" id="saveLead" data-cy="saveLead" *ngIf="!isLeadClosed">Save</button>
      <button *ngIf="showSaveAndNext && !leadsListCompleted && !isLeadClosed" (click)="traverseLeads()" type="button" class="btn btn--positive" [isOpen]="leadsListCompleted" [tooltip]="leadsListCompleted ? 'You have reached the end of the list' : null || !leadEditForm.valid? errorMessage?.displayMessage : ''" placement="top">Save & Next</button>
    </footer>
  </form>
</ng-template>




<!-- <app-breadcrumb></app-breadcrumb> -->
<!-- <div class="container main">
  <div class="row page-title">
    <div class="col">
      <h4 class="m-0">Lead <span class="badge badge-pill badge-primary" *ngIf="lead?.closedById">Closed</span></h4>
    </div>
  </div>

  <form [formGroup]="leadEditForm" (ngSubmit)="SaveLead(true, leadNote)" autocompleteOff>
    <div class="row align-items-start">
      <div class="col-xl-8">
        <h5>Person</h5>
        <app-person-details *ngIf="person" [personDetails]="person"></app-person-details>
        <div #spacer></div>
        <div class="sub-info" stickyThing [spacer]="spacer" marginTop="20">
          <h5>More Info</h5>
          <accordion [closeOthers]="true">
            <accordion-group *ngFor="let item of subNav">
              <button class="btn btn-link btn-block clearfix" accordion-heading type="button"
                (click)="getMoreInfo(item)">
                <div class="pull-left float-left">
                  {{item?.label}}
                  <ng-container *ngIf="summaryTotals; else loadingInfo">
                    <ng-container *ngIf="isObject(summaryTotals[item?.value]); else simpleValue">
                      <span class="badge badge-pill badge-success mr-1"> {{summaryTotals[item?.value]?.active}} </span>
                      <span class="badge badge-pill badge-primary"> {{summaryTotals[item?.value]?.inactive}}</span>
                    </ng-container>
                    <ng-template #simpleValue>
                      <span class="badge badge-pill badge-primary"> {{summaryTotals[item?.value] || '0'}}</span>
                    </ng-template>
                  </ng-container>
                  <ng-template #loadingInfo>
                    <span class="badge badge-pill badge-primary"><i
                        class="fas fa-spinner fa-pulse d-inline-block"></i></span>
                  </ng-template>
                </div>
                <span class="float-right pull-right" (click)="$event.stopPropagation()">
                  <ng-container [ngSwitch]="item?.value">
                    <a [routerLink]="['/property-centre/detail', 0, 'edit']"
                      [queryParams]="{isNewProperty: true, leadId:lead?.leadId,  lastKnownPerson: personParams}"
                      *ngSwitchCase="'properties'">Create</a>
                  </ng-container>
                </span>
              </button>
              <ng-container [ngSwitch]="item?.value">
                <app-shared-property-list *ngSwitchCase="'properties'" [moreInfo]="moreInfo"
                  [isLeadClosed]="isLeadClosed" [isLead]="true" [personId]="person?.personId"
                  (associatedProperty)="getAssociatedProperty($event)">
                </app-shared-property-list>
                <app-contactgroups-detail-instructions *ngSwitchCase="'instructions'" [moreInfo]="moreInfo"
                  [personId]="person?.personId" [closedCounter]="summaryTotals?.instructions?.inactive">
                </app-contactgroups-detail-instructions>
                <app-contactgroups-detail-offers *ngSwitchCase="'offers'" [moreInfo]="moreInfo"
                  [personId]="person?.personId" [closedCounter]="summaryTotals?.offers?.inactive">
                </app-contactgroups-detail-offers>
                <app-contactgroups-detail-searches *ngSwitchCase="'searches'" [moreInfo]="moreInfo"
                  [personId]="person?.personId" [closedCounter]="summaryTotals?.searches?.inactive">
                </app-contactgroups-detail-searches>
                <app-shared-valuation-list *ngSwitchCase="'valuations'" [moreInfo]="moreInfo"
                  [personId]="person?.personId" [closedCounter]="summaryTotals?.valuations?.inactive">
                </app-shared-valuation-list>
                <app-contactgroups-detail-lettings-managements *ngSwitchCase="'lettingsManagements'"
                  [moreInfo]="moreInfo" [personId]="person?.personId"
                  [closedCounter]="summaryTotals?.lettingsManagements?.inactive">
                </app-contactgroups-detail-lettings-managements>
                <app-contactgroups-detail-home-helper *ngSwitchCase="'homeHelpers'" [moreInfo]="moreInfo"
                  [personId]="person?.personId" [closedCounter]="summaryTotals?.homeHelpers?.inactive">
                </app-contactgroups-detail-home-helper>
                <app-shared-lead-register *ngSwitchCase="'leads'" [moreInfo]="moreInfo" [personId]="person?.personId"
                  [closedCounter]="summaryTotals?.leads?.inactive">
                </app-shared-lead-register>
              </ng-container>
            </accordion-group>
          </accordion>
        </div>
        <div class="mb-4 d-xl-none"></div>



        <h5>Lead Info</h5>
        <div class="list-group mb-4">
          <div class="list-group-item pt-4 pb-3">
            <div class="row">
              <div class="col-lg">
                <div class="form-group">
                  <label for="leadType">Type</label>
                  <select class="custom-select custom-select-sm" id="leadType" formControlName="leadTypeId"
                    [attr.disabled]="isLeadClosed ? true : null" [ngClass]="{'is-invalid': formErrors?.leadTypeId}">
                    <option value=""></option>
                    <option selected *ngFor="let leadType of leadTypes" [value]=leadType.id>{{leadType?.value}}</option>
                  </select>
                  <div class="invalid-feedback">{{formErrors?.leadTypeId}}</div>
                </div>
              </div>
              <div class="col-lg">
                <div class="form-group">
                  <label for="chaseDate">Chase date</label>
                  <input type="text" id="chaseDate" placeholder="dd/mm/yyyy" class="form-control form-control-sm"
                    formControlName="nextChaseDate"
                    [bsConfig]="{showWeekNumbers:false, useUtc: false, dateInputFormat: 'DD/MM/YYYY', minDate:tomorrowsDate, customTodayClass: 'font-weight-bold'}"
                    bsDatepicker [attr.disabled]="isLeadClosed ? true : null"
                    #datepicker="bsDatepicker"
                    [appNoDoubleTap]='datepicker'
                    (bsValueChange)="onChaseDateChange($event)"
                    [ngClass]="{'is-invalid': (formErrors?.nextChaseDate)}">
                  <div class="invalid-feedback">{{formErrors?.nextChaseDate}}</div>
                </div>
              </div>
              <div class="col-lg">
                <div class="form-group">
                  <label for="chaser">Chaser</label> -->
<!-- <app-staffmember-finder [staffMemberId]="lead?.ownerId" (ownerChanged)="onOwnerChanged($event)"
                    [isDisabled]="isLeadClosed ? true : false">
                  </app-staffmember-finder> -->
<!-- <app-staff-member-finder [staffMemberId]="lead?.ownerId || leadEditForm.get('ownerId').value" [listType]="'activeStaffMembers'"
                    (selectedStaffMemberId)="getSelectedStaffMemberId($event)"
                    [isRequired]="!leadEditForm.get('ownerId').value"
                    [isDisabled]="isLeadClosed ? true : false"></app-staff-member-finder>
                </div>
              </div>
              <div class="col-12" *ngIf="!isLeadClosed">
                <div class="form-group">
                  <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input" id="closeLead" formControlName="closeLead"
                      (change)="closeLeadChanged(lead)">
                    <label class="custom-control-label small" for="closeLead">Mark as <span
                        class="badge badge-pill badge-primary">Closed</span></label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>



        <h5>Associated Property</h5>
        <ng-container *ngIf="lead?.relatedProperty; else noProperty">
          <p class="d-flex d-sm-block mb-4">
            <a class="mobile-btn"
              [routerLink]="['/property-centre/detail/', lead?.relatedProperty?.propertyId]">
              {{lead?.relatedProperty?.address | formatAddress}}
            </a>
            <ng-container *ngIf="!isMessageVisible && !isLeadClosed">
              <button class="btn btn-light btn-sm ml-2" type="button" aria-label="remove" (click)="removeProperty()">
                <span aria-hidden="true">×</span>
              </button>
            </ng-container>
            <ng-container *ngIf="!isMessageVisible">
              <button class="btn btn-light btn-sm ml-2" type="button" data-cy="createVal"
                (click)="navigateToNewValuation(lead?.relatedProperty?.propertyId)">Create Val.
              </button>
            </ng-container>
          </p>
        </ng-container>
        <ng-template #noProperty>
          <p>
            No property associated to this lead
          </p>
        </ng-template>
        <h5>Notes</h5>
        <div class="list-group" *ngIf="!isLeadClosed">
          <div class="list-group-item add-note py-4">
            <app-lead-note #leadNote [selectedPerson]="person" (leadNote)="getNewPersonNote($event)"
              [noteRequiredWarning]="noteRequiredWarning" [isUpdateComplete]="isUpdateComplete"></app-lead-note>
          </div>
        </div>
        <app-notes [personNotes]="personNotes" [person]="person" [pageNumber]="page" [bottomReached]="bottomReached"
          [showNoteInput]="false"></app-notes>


      </div>
    </div>
    <div class="form-actions">
      <div class="container">
        <div class="row justify-content-end w-100 no-gutters">
          <div class="col-sm-10 d-flex">
            <button (click)="cancel()" type="button" class="btn btn-light mr-2" *ngIf="!isLeadClosed">Cancel</button>
            <button (click)="cancel()" type="button" class="btn btn-secondary mr-2" *ngIf="isLeadClosed">Back</button>
            <button type="submit" class="btn btn-secondary mr-2" id="saveLead" data-cy="saveLead" *ngIf="!isLeadClosed">Save</button>
            <button *ngIf="showSaveAndNext && !leadsListCompleted && !isLeadClosed" (click)="traverseLeads()"
              type="button" class="btn btn-secondary" [isOpen]="leadsListCompleted"
              [tooltip]="leadsListCompleted ? 'You have reached the end of the list' : null || !leadEditForm.valid? errorMessage?.displayMessage : ''"
              placement="top">Save &
              Next</button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>
<app-additional-info [id]="lead?.leadId ? 'L-'+lead?.leadId : ''"></app-additional-info> -->