<div class="row">
  <div class="row__item row__item--aside">
    <app-person-details class="appWrapper" *ngIf="person" [personDetails]="person" [isClickable]="true"
      [showViewPerson]="true"></app-person-details>
    <app-sidenav-item class="appWrapper" [sideNavItems]="sideNavItems" [summaryTotals]="summaryTotals"
      [scrollToItem]="mainRowItem" (selectedItem)="getSelectedItem($event)" (create)="create($event)">
    </app-sidenav-item>
  </div>

  <div #mainRowItem class="row__item">
    <ng-container *ngTemplateOutlet="editForm"></ng-container>
    <ng-container [ngSwitch]="moreInfo">
      <app-shared-property-list *ngSwitchCase="'properties'" [moreInfo]="moreInfo" [canEditLead]="canEditLead"
        [isLeadClosed]="isLeadClosed" [isLead]="true" [personId]="person?.personId"
        (associatedProperty)="getAssociatedProperty($event)">
      </app-shared-property-list>
      <app-contactgroups-detail-instructions *ngSwitchCase="'instructions'" [moreInfo]="moreInfo"
        [personId]="person?.personId" [closedCounter]="summaryTotals?.instructions?.inactive">
      </app-contactgroups-detail-instructions>
      <app-contactgroups-detail-offers *ngSwitchCase="'offers'" [moreInfo]="moreInfo" [personId]="person?.personId"
        [closedCounter]="summaryTotals?.offers?.inactive"></app-contactgroups-detail-offers>
      <app-contactgroups-detail-searches *ngSwitchCase="'searches'" [moreInfo]="moreInfo" [personId]="person?.personId"
        [closedCounter]="summaryTotals?.searches?.inactive"></app-contactgroups-detail-searches>
      <app-shared-valuation-list *ngSwitchCase="'valuations'" [moreInfo]="moreInfo" [personId]="person?.personId"
        [closedCounter]="summaryTotals?.valuations?.inactive"></app-shared-valuation-list>
      <app-contactgroups-detail-lettings-managements *ngSwitchCase="'lettingsManagements'" [moreInfo]="moreInfo"
        [personId]="person?.personId" [closedCounter]="summaryTotals?.lettingsManagements?.inactive">
      </app-contactgroups-detail-lettings-managements>
      <app-contactgroups-detail-home-helper *ngSwitchCase="'homeHelpers'" [moreInfo]="moreInfo"
        [personId]="person?.personId" [closedCounter]="summaryTotals?.homeHelpers?.inactive">
      </app-contactgroups-detail-home-helper>
      <app-shared-lead-register *ngSwitchCase="'leads'" [moreInfo]="moreInfo" [personId]="person?.personId"
        [closedCounter]="summaryTotals?.leads?.inactive"></app-shared-lead-register>
      <app-notes *ngSwitchCase="'notes'" [personNotes]="personNotes" [person]="person" [pageNumber]="page"
        [bottomReached]="bottomReached" [showNoteInput]="false" [showCreateNoteButton]="false"
        (showMyNotes)="setShowMyNotesFlag($event)"></app-notes>
    </ng-container>
  </div>
</div>

<ng-template #editForm>
  <!-- <div class="title">
    <h2>Lead<span class="pill pill--onRight" *ngIf="lead?.closedById">Closed</span></h2>
    <a class="btn btn--positive"><svg aria-hidden="true" width="64" height="64" viewBox="0 0 64 64" class="icon icon--s icon--onLeft"><path d="M60 35.9H4c-2.2 0-4-1.8-4-4v0c0-2.2 1.8-4 4-4h56c2.2 0 4 1.8 4 4v0C64 34.1 62.2 35.9 60 35.9z"></path><path d="M28 59.9v-56c0-2.2 1.8-4 4-4h0c2.2 0 4 1.8 4 4v56c0 2.2-1.8 4-4 4h0C29.8 63.9 28 62.2 28 59.9z" class="plus-vertical"></path></svg>Contact Group</a>
  </div> -->
  <form [formGroup]="leadEditForm" (ngSubmit)="SaveLead(true, leadNote)" autocompleteOff>
    <div class="card card--horizontal">
      <div class="card__body">
        <ol class="list list--split list--split-60-40">
          <li>
            <h3 class="txt--title">Lead details<span class="pill pill--onRight" *ngIf="lead?.closedById">Closed</span>
            </h3>
            <div class="inline-parent inline-parent__hasLabels inline-parent--width-max">
              <fieldset class="inline-child" [ngClass]="{'invalid': formErrors?.leadTypeId}">
                <label for="leadType">Type</label>
                <span class="select">
                  <select id="leadType" formControlName="leadTypeId" [attr.disabled]="!canEditLead ? true : null">
                    <option value=""></option>
                    <option selected *ngFor="let leadType of leadTypes" [value]='leadType?.id'>{{leadType?.value}}</option>
                  </select>
                </span>
                <p class="message message--negative"> {{formErrors?.leadTypeId}}</p>
              </fieldset>

              <fieldset class="inline-child" [ngClass]="{'invalid': (formErrors?.nextChaseDate)}">
                <label for="chaseDate">Chase date</label>
                <input type="text" id="chaseDate" placeholder="dd/mm/yyyy" formControlName="nextChaseDate"
                  [bsConfig]="{showWeekNumbers:false, useUtc: false, dateInputFormat: 'DD/MM/YYYY', minDate:tomorrowsDate, customTodayClass: 'font-weight-bold'}"
                  bsDatepicker [attr.disabled]="!canEditLead ? true : null" #datepicker="bsDatepicker"
                  [appNoDoubleTap]='datepicker' (bsValueChange)="onChaseDateChange($event)">
                <p class="message message--negative">{{formErrors?.nextChaseDate}}</p>
              </fieldset>

              <fieldset class="inline-child">
                <label for="chaser">Chaser</label>
                <app-staff-member-finder class="appWrapper"
                  [staffMemberId]="lead?.ownerId || leadEditForm.get('ownerId').value" [listType]="'activeStaffMembers'"
                  (selectedStaffMemberId)="getSelectedStaffMemberId($event)"
                  [isRequired]="!leadEditForm.get('ownerId').value" [isDisabled]="!canEditLead ? true : false">
                </app-staff-member-finder>
              </fieldset>
            </div>

            <fieldset *ngIf="canEditLead">
              <span class="checkbox">
                <span>
                  <input type="checkbox" id="closeLead" formControlName="closeLead" (change)="closeLeadChanged(lead)"  [attr.disabled]="!canClose ? '':null">
                  <label for="closeLead">Mark as <span class="badge badge-pill badge-primary">Closed</span></label>
                </span>
              </span>
            </fieldset>

            <h3 class="txt--title">Associated Property</h3>
            <ng-container *ngIf="lead?.relatedProperty; else noProperty">
              <!-- <div *ngIf="properties" class="search-results" infiniteScroll [infiniteScrollDistance]="5" [infiniteScrollUpDistance]="1.5" [infiniteScrollThrottle]="20" [immediateCheck]="true" [alwaysCallback]="true"></div> -->
              <ol class="list">
                <li [routerLink]="['/property-centre/detail/', lead?.relatedProperty?.propertyId]">
                  {{lead?.relatedProperty?.address | formatAddress}}
                  <div class="btn--container flexRight">
                    <button class="btn btn--ghost btn--hoverNegative" type="button" aria-label="remove"
                      (click)="removeProperty()" *ngIf="!isMessageVisible && !isLeadClosed"
                      [attr.disabled]="!canEditLead ? true : null"><svg aria-hidden="true" width="64" height="64"
                        viewBox="0 0 64 64" class="icon icon--s icon--onLeft">
                        <path
                          d="M11.4 56.1c0 3.8 3.1 6.9 6.9 6.9h27.4c3.8 0 6.9-3.1 6.9-6.9V14.8H11.4V56.1zM19.9 31.6l4.9-4.9L32 34l7.3-7.3 4.9 4.9 -7.3 7.3 7.3 7.3 -4.9 4.9L32 43.8l-7.3 7.3 -4.9-4.9 7.3-7.3L19.9 31.6zM44 4.4L40.6 1H23.4L20 4.4H8v6.9h48V4.4H44z">
                        </path>
                      </svg>Remove</button>
                    <button class="btn btn--positive" type="button" data-cy="createVal"
                      (click)="navigateToNewValuation(lead?.relatedProperty?.propertyId)" *ngIf="!isMessageVisible"><svg
                        aria-hidden="true" width="64" height="64" viewBox="0 0 64 64" class="icon icon--s icon--onLeft">
                        <path class="horizontal"
                          d="M61 28H3c-1.7 0-3 1.8-3 3.5v1.1C0 34.2 1.3 36 3 36h58c1.7 0 3-1.8 3-3.5v-1C64 29.8 62.7 28 61 28z">
                        </path>
                        <path class="vertical"
                          d="M36 61V3c0-1.7-1.8-3-3.5-3l-1.1 0C29.8 0 28 1.3 28 3v58c0 1.7 1.8 3 3.5 3h1C34.2 64 36 62.7 36 61z">
                        </path>
                      </svg>Valuation</button>
                  </div>
                </li>
              </ol>
            </ng-container>
            <ng-template #noProperty>
              <p>No property associated to this lead</p>
            </ng-template>
          </li>
          <li class="width30pc">
            <div class="wrapper--note" *ngIf="canEditLead">
              <app-lead-note #leadNote [selectedPerson]="person" (leadNote)="getNewPersonNote($event)"
                [noteRequiredWarning]="noteRequiredWarning" [isUpdateComplete]="isUpdateComplete"></app-lead-note>
            </div>
          </li>
        </ol>
      </div>
    </div>
    <footer class="footer">
      <ng-container *ngIf="canEditLead;else noEdit">
        <button (click)="cancel()" type="button" class="btn btn--ghost" *ngIf="!isLeadClosed">Register</button>
        <button *ngIf="!isNewLead" (click)="traverseLeads(false, true)" type="button" class="btn btn--ghost"
          [attr.disabled]="disablePrevious ? '':null">Previous</button>
        <span class="txt--center" *ngIf="!isNewLead"><strong>{{currentLeadIndex + 1}} of {{leadIds?.length}}</strong></span>
        <button type="submit" class="btn btn--positive" id="saveLead" data-cy="saveLead"
          *ngIf="!isLeadClosed">Save</button>
        <button *ngIf="showSaveAndNext && !leadsListCompleted && !isLeadClosed" (click)="traverseLeads(true)"
          type="button" class="btn btn--positive" [isOpen]="leadsListCompleted"
          [attr.disabled]="leadsListCompleted ? '':null">Save & Next</button>
      </ng-container>
      <ng-template #noEdit>
        <button (click)="traverseLeads(false, true)" type="button" class="btn btn--ghost"
          [attr.disabled]="disablePrevious ? '':null">Previous</button>
        <button (click)="traverseLeads(false, false)" type="button" class="btn btn--positive"
          [attr.disabled]="disableNext ? '':null">Next</button>
      </ng-template>
    </footer>
  </form>
</ng-template>

<!--Success Messages -->
<p-toast></p-toast>

<!-- <app-additional-info [id]="lead?.leadId ? 'L-'+lead?.leadId : ''"></app-additional-info> -->